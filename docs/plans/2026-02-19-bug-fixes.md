# Bug Fixes Plan: 配置为空 + 窗口控制失效

## 问题总结

1. **CLAUDE.md 路径错误**：读取 `~/CLAUDE.md` 而非 `~/.claude/CLAUDE.md`
2. **供应商配置为空**：首次启动时 SQLite DB 为空，未从 `~/.claude/settings.json` 导入
3. **窗口控制失效**：`capabilities/default.json` 缺少窗口操作权限

---

## Task 1: 修复 CLAUDE.md 路径

**文件**: `src-tauri/src/services/docs_service.rs`

将两处 `home.join("CLAUDE.md")` 改为 `home.join(".claude").join("CLAUDE.md")`：

- Line 14（get_claude_md）
- Line 31（save_claude_md）

**验证**: 读取/保存 CLAUDE.md 时路径为 `~/.claude/CLAUDE.md`

---

## Task 2: 添加 read_claude_settings 函数

**文件**: `src-tauri/src/utils/config_parser.rs`

在文件末尾添加：

```rust
pub fn read_claude_settings() -> Result<Option<VendorInput>, AppError> {
    let home = dirs::home_dir().ok_or(AppError::FileSystem(std::io::Error::new(
        std::io::ErrorKind::NotFound,
        "Home directory not found",
    )))?;
    let settings_path = home.join(".claude").join("settings.json");
    if !settings_path.exists() {
        return Ok(None);
    }
    let content = std::fs::read_to_string(&settings_path)?;
    let settings: serde_json::Value = serde_json::from_str(&content).unwrap_or_default();
    let token = settings["env"]["ANTHROPIC_AUTH_TOKEN"]
        .as_str()
        .unwrap_or("")
        .to_string();
    let base_url = settings["env"]["ANTHROPIC_BASE_URL"]
        .as_str()
        .unwrap_or("")
        .to_string();
    if token.is_empty() && base_url.is_empty() {
        return Ok(None);
    }
    Ok(Some(VendorInput {
        name: "导入的配置".to_string(),
        vendor_key: None,
        base_url,
        token,
        model: settings["env"]["ANTHROPIC_MODEL"]
            .as_str()
            .map(|s| s.to_string()),
        config_json: None,
    }))
}
```

需要在文件顶部添加 `use crate::models::vendor::VendorInput;`

**验证**: 函数能正确解析 `~/.claude/settings.json` 中的 env 字段

---

## Task 3: 启动时自动导入供应商配置

**文件**: `src-tauri/src/lib.rs`

在 `.setup()` 中，DB 初始化后添加自动导入逻辑：

```rust
.setup(|app| {
    let app_dir = app.path().app_data_dir()...;
    let db = Database::new(app_dir)...;

    // 若 claude-code 供应商列表为空，从 settings.json 自动导入
    if VendorService::get_all(&db, "claude-code")
        .unwrap_or_default()
        .is_empty()
    {
        if let Ok(Some(input)) = utils::config_parser::read_claude_settings() {
            if let Ok(vendor) = services::vendor_service::VendorService::add(&db, "claude-code", input) {
                let _ = services::vendor_service::VendorService::activate(&db, "claude-code", vendor.id);
            }
        }
    }

    app.manage(db);
    Ok(())
})
```

需要在 lib.rs 顶部确保 `use crate::services::vendor_service::VendorService;` 和 `use crate::utils;`

**验证**: 首次启动时若 `~/.claude/settings.json` 存在且有 token/base_url，自动创建并激活一条 vendor 记录

---

## Task 4: 修复窗口控制权限

**文件**: `src-tauri/capabilities/default.json`

将 permissions 数组改为：

```json
"permissions": [
  "core:default",
  "opener:default",
  "core:window:allow-minimize",
  "core:window:allow-toggle-maximize",
  "core:window:allow-close",
  "core:window:allow-start-dragging"
]
```

**验证**: 最小化、最大化、关闭按钮正常工作，标题栏可拖动

---

## 执行顺序

Task 1 → Task 2 → Task 3 → Task 4

Task 2 必须在 Task 3 之前完成（Task 3 依赖 Task 2 的函数）。
